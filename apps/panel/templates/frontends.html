{% extends "base.html" %}

{% block title %}Frontend Servers - EXA-ROBOT{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Frontend Servers</h2>
            <p class="text-muted">Manage distributed subscription and Mini App servers for RKN resilience</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFrontendModal">
                <i class="bi bi-plus-circle"></i> Add Frontend Server
            </button>
        </div>
    </div>

    <!-- Frontend Servers List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="frontendsList" class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Region</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Traffic (Month)</th>
                                    <th>Last Seen</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="frontendsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading frontends...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Frontend Modal -->
<div class="modal fade" id="addFrontendModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Frontend Server</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFrontendForm">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain</label>
                        <input type="text" class="form-control" id="domain" name="domain"
                            placeholder="frontend-eu.example.com" required>
                        <small class="text-muted">Fully qualified domain name (DNS must be configured)</small>
                    </div>

                    <div class="mb-3">
                        <label for="ip_address" class="form-label">Server IP Address</label>
                        <input type="text" class="form-control" id="ip_address" name="ip_address" placeholder="1.2.3.4"
                            required>
                    </div>

                    <div class="mb-3">
                        <label for="region" class="form-label">Region</label>
                        <select class="form-select" id="region" name="region" required>
                            <option value="">Select region...</option>
                            <option value="eu">Europe</option>
                            <option value="us">USA</option>
                            <option value="asia">Asia</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        After creation, you'll receive an installation command to run on the server.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createFrontendBtn">
                    Create & Generate Install Command
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Install Command Modal -->
<div class="modal fade" id="installCommandModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Frontend Server Created
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Installation Command:</h6>
                <p class="text-muted">Run this command on your frontend server:</p>

                <div class="position-relative">
                    <pre id="installCommand" class="bg-dark text-light p-3 rounded"
                        style="font-family: 'Courier New', monospace; font-size: 13px;"></pre>
                    <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" id="copyInstallCmd">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>

                <div class="alert alert-warning mt-3">
                    <strong>⚠️ Save this command!</strong> The auth token cannot be retrieved later.
                </div>

                <div class="mt-3">
                    <h6>Next Steps:</h6>
                    <ol>
                        <li>SSH into your server: <code>ssh root@<span id="serverIP"></span></code></li>
                        <li>Paste and run the installation command</li>
                        <li>Wait 2-3 minutes for setup to complete</li>
                        <li>Verify: <code>curl https://<span id="serverDomain"></span>/health</code></li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Load frontends
    async function loadFrontends() {
        try {
            const response = await fetch('/api/admin/frontends');
            const frontends = await response.json();

            const tbody = document.getElementById('frontendsTableBody');

            if (frontends.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        No frontend servers yet. Click "Add Frontend Server" to get started.
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = frontends.map(f => `
            <tr>
                <td>
                    <a href="https://${f.domain}" target="_blank" class="text-decoration-none">
                        ${f.domain} <i class="bi bi-box-arrow-up-right small"></i>
                    </a>
                </td>
                <td><span class="badge bg-secondary">${f.region.toUpperCase()}</span></td>
                <td><code>${f.ip_address}</code></td>
                <td>
                    ${f.is_active ?
                    '<span class="badge bg-success">Active</span>' :
                    '<span class="badge bg-danger">Inactive</span>'}
                </td>
                <td>${formatBytes(f.traffic_monthly)}</td>
                <td>
                    ${f.last_heartbeat ?
                    `<span class="text-muted">${timeAgo(f.last_heartbeat)}</span>` :
                    '<span class="text-warning">Never</span>'}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="testFrontend('${f.domain}')">
                            <i class="bi bi-check-circle"></i> Test
                        </button>
                        <button class="btn btn-outline-warning" onclick="rotateToken(${f.id})">
                            <i class="bi bi-arrow-repeat"></i> Rotate Token
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteFrontend(${f.id}, '${f.domain}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        } catch (error) {
            console.error('Failed to load frontends:', error);
            document.getElementById('frontendsTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Failed to load frontends. Please refresh the page.
                </td>
            </tr>
        `;
        }
    }

    // Create frontend
    document.getElementById('createFrontendBtn')?.addEventListener('click', async () => {
        const form = document.getElementById('addFrontendForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/api/admin/frontends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to create frontend');

            const result = await response.json();

            // Hide add modal
            bootstrap.Modal.getInstance(document.getElementById('addFrontendModal')).hide();

            // Show install command modal
            document.getElementById('installCommand').textContent = result.install_command;
            document.getElementById('serverIP').textContent = data.ip_address;
            document.getElementById('serverDomain').textContent = data.domain;

            const installModal = new bootstrap.Modal(document.getElementById('installCommandModal'));
            installModal.show();

            // Reload frontends list
            loadFrontends();

            // Reset form
            form.reset();
        } catch (error) {
            alert('Failed to create frontend: ' + error.message);
        }
    });

    // Copy install command
    document.getElementById('copyInstallCmd')?.addEventListener('click', () => {
        const command = document.getElementById('installCommand').textContent;
        navigator.clipboard.writeText(command);

        const btn = document.getElementById('copyInstallCmd');
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        }, 2000);
    });

    // Test frontend
    async function testFrontend(domain) {
        try {
            const response = await fetch(`https://${domain}/health`);
            const data = await response.json();
            alert(`✅ Frontend is healthy!\n\nStatus: ${data.status}\nRegion: ${data.region}`);
        } catch (error) {
            alert(`❌ Frontend is not responding:\n\n${error.message}`);
        }
    }

    // Delete frontend
    async function deleteFrontend(id, domain) {
        if (!confirm(`Are you sure you want to delete ${domain}?`)) return;

        try {
            const response = await fetch(`/api/admin/frontends/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete');

            alert('Frontend deleted successfully');
            loadFrontends();
        } catch (error) {
            alert('Failed to delete frontend: ' + error.message);
        }
    }

    // Rotate token
    async function rotateToken(id) {
        if (!confirm('This will invalidate the current token. The frontend service will need to be updated with the new token. Continue?')) return;

        try {
            const response = await fetch(`/api/admin/frontends/${id}/rotate-token`, {
                method: 'POST'
            });

            if (!response.ok) throw new Error('Failed to rotate token');

            const data = await response.json();

            alert(`Token rotated successfully!\n\nNew token: ${data.token}\n\n${data.instructions}`);
        } catch (error) {
            alert('Failed to rotate token: ' + error.message);
        }
    }

    // Utilities
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
    }

    // Load on page load
    loadFrontends();

    // Refresh every 30 seconds
    setInterval(loadFrontends, 30000);
</script>

<style>
    .badge {
        font-size: 0.85em;
    }

    pre {
        max-height: 300px;
        overflow-y: auto;
    }

    code {
        color: #d63384;
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
    }
</style>
{% endblock %}